{% extends "base.html" %}

{% block title %}Chart Analysis Dashboard{% endblock %}

{% block content %}
<style>
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

@keyframes flash {
    0% { background-color: transparent; }
    50% { background-color: rgba(255, 255, 255, 0.2); }
    100% { background-color: transparent; }
}

.price-update {
    animation: flash 0.8s ease-in-out;
}

.live-badge {
    animation: pulse 2s infinite;
}
</style>

<div class="container-fluid mt-3">
    <!-- Top Recommendations Banner -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card bg-primary text-white">
                <div class="card-body py-3">
                    <div class="row text-center">
                        <div class="col-md-6">
                            <h6 class="mb-2">
                                üïê HOURLY RECOMMENDATIONS
                                <span id="live-indicator-hourly" class="badge bg-success ms-2" style="font-size: 0.6em;">LIVE</span>
                            </h6>
                            <div class="row">
                                <div class="col-6">
                                    <div class="badge bg-success fs-6 mb-1">LONG</div>
                                    <div id="hourly-long" class="fw-bold">Loading...</div>
                                </div>
                                <div class="col-6">
                                    <div class="badge bg-danger fs-6 mb-1">SHORT</div>
                                    <div id="hourly-short" class="fw-bold">Loading...</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-2">
                                üìÖ DAILY RECOMMENDATIONS
                                <span id="live-indicator-daily" class="badge bg-success ms-2" style="font-size: 0.6em;">LIVE</span>
                            </h6>
                            <div class="row">
                                <div class="col-6">
                                    <div class="badge bg-success fs-6 mb-1">LONG</div>
                                    <div id="daily-long" class="fw-bold">Loading...</div>
                                </div>
                                <div class="col-6">
                                    <div class="badge bg-danger fs-6 mb-1">SHORT</div>
                                    <div id="daily-short" class="fw-bold">Loading...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trading Signals Summary -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>Trading Signals
                    </h5>
                </div>
                <div class="card-body">
                    <div id="signals-loading" class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading signals...</span>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Token</th>
                                    <th>Current Price</th>
                                    <th>7d Change</th>
                                    <th>Signal</th>
                                    <th>Confidence</th>
                                    <th>Bybit Settings</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="signals-table">
                                <!-- Signals will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Analysis Cards -->
    <div class="row">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-bullseye fa-2x text-success mb-2"></i>
                    <h5 class="card-title">Strong Signals</h5>
                    <p class="card-text display-6" id="strong-signals">-</p>
                    <small class="text-muted">High confidence trades</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-chart-bar fa-2x text-info mb-2"></i>
                    <h5 class="card-title">Buy Signals</h5>
                    <p class="card-text display-6" id="buy-signals">-</p>
                    <small class="text-muted">Bullish opportunities</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-chart-line-down fa-2x text-warning mb-2"></i>
                    <h5 class="card-title">Sell Signals</h5>
                    <p class="card-text display-6" id="sell-signals">-</p>
                    <small class="text-muted">Bearish warnings</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-pause fa-2x text-secondary mb-2"></i>
                    <h5 class="card-title">Hold Signals</h5>
                    <p class="card-text display-6" id="hold-signals">-</p>
                    <small class="text-muted">Wait and watch</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Token Analysis Modal -->
<div class="modal fade" id="analysisModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Technical Analysis - <span id="modal-token-name"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="analysis-loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Analyzing...</span>
                    </div>
                </div>
                <div id="analysis-content" style="display: none;">
                    <!-- Analysis content will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="/analysis" class="btn btn-primary">Detailed Analysis</a>
            </div>
        </div>
    </div>
</div>

<!-- Bybit Settings Modal -->
<div class="modal fade" id="bybitModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-cog me-2"></i>Bybit Futures Settings - <span id="bybit-token-name"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="bybit-loading" class="text-center py-4">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Loading settings...</span>
                    </div>
                </div>
                <div id="bybit-content" style="display: none;">
                    <!-- Bybit settings will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" onclick="copyBybitSettings()">
                    <i class="fas fa-copy"></i> Copy Settings
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Dashboard functionality
let currentSignals = [];

// Load dashboard data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadTradingSignals();
    
    // Auto-refresh every 30 seconds for live updates
    setInterval(loadTradingSignals, 30000);
    
    // Add visual indicator for live updates
    addLiveUpdateIndicator();
});

function loadTradingSignals() {
    fetch('/api/signals')
        .then(response => response.json())
        .then(data => {
            // Handle authentication required response
            if (data.error && data.status === 'authentication_required') {
                displayAuthenticationRequired(data);
                document.getElementById('signals-loading').style.display = 'none';
                return;
            }
            
            // Handle successful data response
            if (Array.isArray(data)) {
                currentSignals = data;
                displaySignals(data);
                updateSummaryCards(data);
                updateTopRecommendations(data);
                flashLiveIndicators();
            } else {
                // Handle error response
                displaySignalsError(data.error || 'Unknown error');
            }
            
            document.getElementById('signals-loading').style.display = 'none';
        })
        .catch(error => {
            console.error('Error loading signals:', error);
            displaySignalsError('Failed to connect to trading data');
        });
}

function displayAuthenticationRequired(data) {
    const signalsContainer = document.getElementById('signals-loading');
    signalsContainer.innerHTML = `
        <div class="alert alert-warning">
            <h5><i class="fas fa-key me-2"></i>API Authentication Required</h5>
            <p>${data.message}</p>
            <div class="mt-3">
                <a href="/api-setup" class="btn btn-primary">
                    <i class="fas fa-cog me-2"></i>Configure API Access
                </a>
            </div>
        </div>
    `;
    
    // Update summary cards to show authentication required
    updateSummaryCards([]);
    updateTopRecommendations([]);
}

function displaySignalsError(error) {
    const signalsContainer = document.getElementById('signals-loading');
    signalsContainer.innerHTML = `
        <div class="alert alert-danger">
            <h5><i class="fas fa-exclamation-triangle me-2"></i>Data Access Error</h5>
            <p>${error}</p>
            <div class="mt-3">
                <button class="btn btn-outline-light" onclick="loadTradingSignals()">
                    <i class="fas fa-redo me-2"></i>Retry
                </button>
                <a href="/api-setup" class="btn btn-primary ms-2">
                    <i class="fas fa-cog me-2"></i>Check API Setup
                </a>
            </div>
        </div>
    `;
}

function displaySignals(signals) {
    const tbody = document.getElementById('signals-table');
    
    // Find the best token (highest confidence)
    const bestToken = signals.reduce((best, current) => 
        current.confidence > best.confidence ? current : best, signals[0]);
    
    tbody.innerHTML = signals.map(signal => {
        const signalBadge = getSignalBadge(signal.signal);
        const confidenceBar = getConfidenceBar(signal.confidence);
        const changeColor = signal.price_change_7d >= 0 ? 'text-success' : 'text-danger';
        const isBest = signal.symbol === bestToken.symbol;
        
        return `
            <tr ${isBest ? 'class="table-warning"' : ''}>
                <td>
                    <strong>${signal.symbol}</strong>
                    ${isBest ? '<span class="text-warning ms-1">‚≠ê</span>' : ''}
                    <br>
                    <small class="text-muted">${signal.name}</small>
                </td>
                <td>$${formatPrice(signal.current_price)}</td>
                <td class="${changeColor}">
                    ${signal.price_change_7d >= 0 ? '+' : ''}${signal.price_change_7d.toFixed(2)}%
                </td>
                <td>${signalBadge}</td>
                <td>${confidenceBar}</td>
                <td>
                    <button class="btn btn-outline-info btn-sm" onclick="showBybitSettings('${signal.symbol}')">
                        <i class="fas fa-cog"></i> Bybit
                    </button>
                </td>
                <td>
                    <button class="btn btn-outline-primary btn-sm" onclick="showAnalysis('${signal.symbol}')">
                        <i class="fas fa-chart-line"></i> Analyze
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function updateSummaryCards(signals) {
    // Handle case when signals is not an array (authentication required, etc.)
    if (!Array.isArray(signals)) {
        signals = [];
    }
    
    const strongSignals = signals.filter(s => s.confidence >= 0.7).length;
    const buySignals = signals.filter(s => s.signal === 'BUY').length;
    const sellSignals = signals.filter(s => s.signal === 'SELL').length;
    const holdSignals = signals.filter(s => s.signal === 'HOLD').length;
    
    document.getElementById('strong-signals').textContent = strongSignals;
    document.getElementById('buy-signals').textContent = buySignals;
    document.getElementById('sell-signals').textContent = sellSignals;
    document.getElementById('hold-signals').textContent = holdSignals;
}

function updateTopRecommendations(signals) {
    // Handle case when signals is not an array (authentication required, etc.)
    if (!Array.isArray(signals)) {
        signals = [];
    }
    
    // Find best BUY signals (highest confidence)
    const buySignals = signals.filter(s => s.signal === 'BUY').sort((a, b) => b.confidence - a.confidence);
    
    // Find best SELL signals (highest confidence)
    const sellSignals = signals.filter(s => s.signal === 'SELL').sort((a, b) => b.confidence - a.confidence);
    
    // Find the absolute best token (highest confidence overall)
    const allSignals = [...buySignals, ...sellSignals];
    const absoluteBest = allSignals.length > 0 ? 
        allSignals.reduce((best, current) => current.confidence > best.confidence ? current : best) : null;
    
    // Update hourly recommendations
    const bestLong = buySignals.length > 0 ? buySignals[0] : null;
    const bestShort = sellSignals.length > 0 ? sellSignals[0] : null;
    
    const longHtml = bestLong ? 
        `${bestLong.symbol} (${Math.round(bestLong.confidence * 100)}%)${absoluteBest && bestLong.symbol === absoluteBest.symbol ? ' ‚≠ê' : ''}` : 'No signals';
    
    const shortHtml = bestShort ? 
        `${bestShort.symbol} (${Math.round(bestShort.confidence * 100)}%)${absoluteBest && bestShort.symbol === absoluteBest.symbol ? ' ‚≠ê' : ''}` : 'No signals';
    
    document.getElementById('hourly-long').innerHTML = longHtml;
    document.getElementById('hourly-short').innerHTML = shortHtml;
    
    // Daily recommendations (same data for now)
    document.getElementById('daily-long').innerHTML = longHtml;
    document.getElementById('daily-short').innerHTML = shortHtml;
}

function addLiveUpdateIndicator() {
    // Add last updated timestamp
    const timestamp = document.createElement('div');
    timestamp.id = 'last-updated';
    timestamp.className = 'text-end mt-2';
    timestamp.style.fontSize = '0.8em';
    timestamp.innerHTML = '<small class="text-muted">Last updated: Loading...</small>';
    
    const banner = document.querySelector('.card.bg-primary .card-body');
    banner.appendChild(timestamp);
    
    updateTimestamp();
}

function updateTimestamp() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString();
    const timestampEl = document.getElementById('last-updated');
    if (timestampEl) {
        timestampEl.innerHTML = `<small class="text-light">Last updated: ${timeStr}</small>`;
    }
}

function flashLiveIndicators() {
    // Flash the LIVE indicators to show data refresh
    const indicators = ['live-indicator-hourly', 'live-indicator-daily'];
    
    indicators.forEach(id => {
        const indicator = document.getElementById(id);
        if (indicator) {
            indicator.style.animation = 'pulse 0.5s ease-in-out';
            setTimeout(() => {
                indicator.style.animation = '';
            }, 500);
        }
    });
    
    updateTimestamp();
}

function getSignalBadge(signal) {
    const badges = {
        'BUY': '<span class="badge bg-success">BUY</span>',
        'SELL': '<span class="badge bg-danger">SELL</span>',
        'HOLD': '<span class="badge bg-secondary">HOLD</span>'
    };
    return badges[signal] || '<span class="badge bg-light">UNKNOWN</span>';
}

function getConfidenceBar(confidence) {
    const percentage = Math.round(confidence * 100);
    const colorClass = percentage >= 70 ? 'bg-success' : percentage >= 50 ? 'bg-warning' : 'bg-danger';
    
    return `
        <div class="progress" style="height: 20px;">
            <div class="progress-bar ${colorClass}" role="progressbar" 
                 style="width: ${percentage}%" aria-valuenow="${percentage}" 
                 aria-valuemin="0" aria-valuemax="100">
                ${percentage}%
            </div>
        </div>
    `;
}

function showAnalysis(symbol) {
    const modal = new bootstrap.Modal(document.getElementById('analysisModal'));
    document.getElementById('modal-token-name').textContent = symbol;
    document.getElementById('analysis-loading').style.display = 'block';
    document.getElementById('analysis-content').style.display = 'none';
    
    modal.show();
    
    // Load detailed analysis
    fetch(`/api/chart-analysis/${symbol}`)
        .then(response => response.json())
        .then(data => {
            displayAnalysisData(data);
            document.getElementById('analysis-loading').style.display = 'none';
            document.getElementById('analysis-content').style.display = 'block';
        })
        .catch(error => {
            console.error('Error loading analysis:', error);
            document.getElementById('analysis-loading').innerHTML = 
                '<div class="alert alert-danger">Error loading analysis</div>';
        });
}

function displayAnalysisData(data) {
    const content = document.getElementById('analysis-content');
    
    const indicators = data.technical_indicators || {};
    const recommendation = data.recommendation || 'HOLD';
    const confidence = Math.round((data.confidence || 0) * 100);
    
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Current Analysis</h6>
                <table class="table table-sm">
                    <tr><td><strong>Price:</strong></td><td>$${formatPrice(data.current_price)}</td></tr>
                    <tr><td><strong>Recommendation:</strong></td><td>${getSignalBadge(recommendation)}</td></tr>
                    <tr><td><strong>Confidence:</strong></td><td>${confidence}%</td></tr>
                    <tr><td><strong>7d Change:</strong></td><td class="${data.price_change_7d >= 0 ? 'text-success' : 'text-danger'}">${data.price_change_7d}%</td></tr>
                    <tr><td><strong>Volatility:</strong></td><td>${data.volatility}%</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Technical Indicators</h6>
                <table class="table table-sm">
                    <tr><td><strong>RSI:</strong></td><td>${Math.round(indicators.rsi || 0)}</td></tr>
                    <tr><td><strong>SMA Trend:</strong></td><td>${indicators.sma_trend || 'N/A'}</td></tr>
                    <tr><td><strong>MACD Trend:</strong></td><td>${indicators.macd_trend || 'N/A'}</td></tr>
                    <tr><td><strong>Momentum:</strong></td><td>${indicators.price_momentum || 'N/A'}</td></tr>
                    <tr><td><strong>Support Levels:</strong></td><td>${indicators.support_levels || 0}</td></tr>
                </table>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <div class="alert alert-info">
                    <strong>Analysis Quality:</strong> ${data.analysis_quality || 'basic'}
                    <br>
                    <strong>Last Updated:</strong> ${new Date(data.last_updated).toLocaleString()}
                </div>
            </div>
        </div>
    `;
}

function showBybitSettings(symbol) {
    const modal = new bootstrap.Modal(document.getElementById('bybitModal'));
    document.getElementById('bybit-token-name').textContent = symbol;
    document.getElementById('bybit-loading').style.display = 'block';
    document.getElementById('bybit-content').style.display = 'none';
    
    modal.show();
    
    // Load Bybit trading settings
    fetch(`/api/chart-analysis/${symbol}`)
        .then(response => response.json())
        .then(data => {
            displayBybitSettings(data);
            document.getElementById('bybit-loading').style.display = 'none';
            document.getElementById('bybit-content').style.display = 'block';
        })
        .catch(error => {
            console.error('Error loading Bybit settings:', error);
            document.getElementById('bybit-loading').innerHTML = 
                '<div class="alert alert-danger">Error loading Bybit settings</div>';
        });
}

function displayBybitSettings(data) {
    const content = document.getElementById('bybit-content');
    const settings = data.bybit_settings || {};
    const signal = data.recommendation || 'HOLD';
    const confidence = Math.round((data.confidence || 0) * 100);
    
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6 class="text-warning mb-3"><i class="fas fa-chart-line me-2"></i>Trade Setup</h6>
                <div class="card mb-3">
                    <div class="card-body">
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Signal:</strong></td>
                                <td><span class="badge ${signal === 'BUY' ? 'bg-success' : signal === 'SELL' ? 'bg-danger' : 'bg-secondary'}">${signal}</span></td>
                            </tr>
                            <tr>
                                <td><strong>Confidence:</strong></td>
                                <td>${confidence}%</td>
                            </tr>
                            <tr>
                                <td><strong>Margin Mode:</strong></td>
                                <td><span class="badge ${settings.margin_mode === 'isolated' ? 'bg-warning' : 'bg-info'}">${settings.margin_mode || 'N/A'}</span></td>
                            </tr>
                            <tr>
                                <td><strong>Leverage:</strong></td>
                                <td><span class="badge bg-primary">${settings.leverage || 'N/A'}</span></td>
                            </tr>
                            <tr>
                                <td><strong>Order Type:</strong></td>
                                <td><span class="badge bg-secondary">${settings.order_type || 'N/A'}</span></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <h6 class="text-warning mb-3"><i class="fas fa-dollar-sign me-2"></i>Price Levels</h6>
                <div class="card mb-3">
                    <div class="card-body">
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Entry Price:</strong></td>
                                <td>$${settings.entry_price_usdt ? settings.entry_price_usdt.toFixed(6) : 'N/A'}</td>
                            </tr>
                            <tr>
                                <td><strong>Position Size:</strong></td>
                                <td>$${settings.position_size_usdt || 'N/A'} USDT</td>
                            </tr>
                            <tr class="table-success">
                                <td><strong>Take Profit:</strong></td>
                                <td>$${settings.take_profit_usdt ? settings.take_profit_usdt.toFixed(6) : 'N/A'} <small>(${settings.tp_percentage || 'N/A'})</small></td>
                            </tr>
                            <tr class="table-danger">
                                <td><strong>Stop Loss:</strong></td>
                                <td>$${settings.stop_loss_usdt ? settings.stop_loss_usdt.toFixed(6) : 'N/A'} <small>(${settings.sl_percentage || 'N/A'})</small></td>
                            </tr>
                            <tr>
                                <td><strong>Risk/Reward:</strong></td>
                                <td><span class="badge bg-info">${settings.risk_reward_ratio || 'N/A'}</span></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <h6 class="text-warning mb-3"><i class="fas fa-cogs me-2"></i>Advanced Settings</h6>
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" ${settings.post_only ? 'checked' : ''} disabled>
                                    <label class="form-check-label">Post Only</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" ${settings.reduce_only ? 'checked' : ''} disabled>
                                    <label class="form-check-label">Reduce Only</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">Timeframe: <strong>${settings.recommended_timeframe || 'N/A'}</strong></small>
                            </div>
                        </div>
                        <hr>
                        <div class="alert alert-info mt-3">
                            <small><i class="fas fa-info-circle me-1"></i>
                            Copy these settings to your Bybit futures interface. Always verify prices before executing.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function copyBybitSettings() {
    const content = document.getElementById('bybit-content').innerText;
    navigator.clipboard.writeText(content).then(() => {
        showNotification('Bybit settings copied to clipboard!', 'success');
    });
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 3000);
}

function formatPrice(price) {
    if (price >= 1000) {
        return price.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
    } else if (price >= 1) {
        return price.toFixed(2);
    } else {
        return price.toFixed(4);
    }
}

// Auto-refresh signals every 30 seconds
setInterval(loadTradingSignals, 30000);
</script>
{% endblock %}